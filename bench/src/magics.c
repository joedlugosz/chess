#include "position.h"
const int rook_magic_shift[N_SQUARES] = {
    52, 53, 53, 53, 53, 53, 53, 52, 53, 54, 54, 54, 54, 54, 54, 53,
    53, 54, 54, 54, 54, 54, 54, 53, 53, 54, 54, 54, 54, 54, 54, 53,
    53, 54, 54, 54, 54, 54, 54, 53, 53, 54, 54, 54, 54, 54, 54, 53,
    53, 54, 54, 54, 54, 54, 54, 53, 52, 53, 53, 53, 53, 53, 53, 52,
};

const bitboard_t rook_magic_number[N_SQUARES] = {
    0x1080082040008010, 0x0040400020001000, 0x0080098020003004,
    0x0100081001600500, 0x20800a0800040080, 0x0080010400020080,
    0x0280010002002080, 0x0080004100002480, 0xa000800080204010,
    0x8000400250002009, 0x0008802002801000, 0x0001801000180080,
    0x1000808008000400, 0x8012800400820080, 0x0882000401020008,
    0x4100800100284080, 0x0080014000a00040, 0x08c0004020100040,
    0x0001010040200010, 0xa401010010002008, 0x0080808004010800,
    0x0200808004000200, 0x8442010001000402, 0x2403004000800040,
    0x0409004100228000, 0x00a0400180200090, 0x4004600080500080,
    0x0010040140080040, 0x0088880080140080, 0x0001000700084400,
    0x4100100400080102, 0x0002408200004401, 0x8001804000800020,
    0x409000a000400840, 0x0810100080802000, 0x1005002009001000,
    0x4a00801800800400, 0x0100804201800400, 0x0000800200800100,
    0x09000100c2000084, 0x1000904000208002, 0x0000400020008080,
    0x0030a00010008080, 0x00021042000a0020, 0x0000080400808005,
    0x0002001008020084, 0x0000210002008080, 0x0001000084410002,
    0x9100800040003080, 0x0000200184c00080, 0x0009009020004300,
    0x0000080280100080, 0x0101080045001100, 0x0084044020100801,
    0x0200020801101c00, 0x0080110041840200, 0x0010102040800301,
    0x2020204000810011, 0x0000200018104501, 0x0000042009001001,
    0x0002001004082102, 0x8002002804100102, 0x0000028910020804,
    0x0000010084007042,
};

const bitboard_t rook_magic_mask[N_SQUARES] = {
    0x000101010101017e, 0x000202020202027c, 0x000404040404047a,
    0x0008080808080876, 0x001010101010106e, 0x002020202020205e,
    0x004040404040403e, 0x008080808080807e, 0x0001010101017e00,
    0x0002020202027c00, 0x0004040404047a00, 0x0008080808087600,
    0x0010101010106e00, 0x0020202020205e00, 0x0040404040403e00,
    0x0080808080807e00, 0x00010101017e0100, 0x00020202027c0200,
    0x00040404047a0400, 0x0008080808760800, 0x00101010106e1000,
    0x00202020205e2000, 0x00404040403e4000, 0x00808080807e8000,
    0x000101017e010100, 0x000202027c020200, 0x000404047a040400,
    0x0008080876080800, 0x001010106e101000, 0x002020205e202000,
    0x004040403e404000, 0x008080807e808000, 0x0001017e01010100,
    0x0002027c02020200, 0x0004047a04040400, 0x0008087608080800,
    0x0010106e10101000, 0x0020205e20202000, 0x0040403e40404000,
    0x0080807e80808000, 0x00017e0101010100, 0x00027c0202020200,
    0x00047a0404040400, 0x0008760808080800, 0x00106e1010101000,
    0x00205e2020202000, 0x00403e4040404000, 0x00807e8080808000,
    0x007e010101010100, 0x007c020202020200, 0x007a040404040400,
    0x0076080808080800, 0x006e101010101000, 0x005e202020202000,
    0x003e404040404000, 0x007e808080808000, 0x7e01010101010100,
    0x7c02020202020200, 0x7a04040404040400, 0x7608080808080800,
    0x6e10101010101000, 0x5e20202020202000, 0x3e40404040404000,
    0x7e80808080808000,
};

const int bishop_magic_shift[N_SQUARES] = {
    58, 59, 59, 59, 59, 59, 59, 58, 59, 59, 59, 59, 59, 59, 59, 59,
    59, 59, 57, 57, 57, 57, 59, 59, 59, 59, 57, 55, 55, 57, 59, 59,
    59, 59, 57, 55, 55, 57, 59, 59, 59, 59, 57, 57, 57, 57, 59, 59,
    59, 59, 59, 59, 59, 59, 59, 59, 58, 59, 59, 59, 59, 59, 59, 58,
};

const bitboard_t bishop_magic_number[N_SQUARES] = {
    0x2002044108022000, 0x0004080084100000, 0x0001081202418000,
    0x8002021200000100, 0x400d0a0200100000, 0x00c0821000000400,
    0x0001011002010010, 0x0000a06202100000, 0x0402282008020000,
    0x0000025001028000, 0x0000010802404884, 0x0800088082804000,
    0x8000020200000000, 0x0020011008000804, 0x0800008c04120200,
    0x0051020201010080, 0x0800001888010410, 0x0000000808808400,
    0x0100000048208100, 0x0010000200221540, 0x0000002a00800005,
    0x0000048241100001, 0x0001000218420000, 0x0000080145009000,
    0x0500040042081800, 0x2000100120010100, 0x400002020c180200,
    0x0000004006201050, 0x0000c01004010012, 0x1020080000220000,
    0x00100400020a0000, 0x0090090002004200, 0x0400088400083000,
    0x0080042000040100, 0x0803020080010104, 0x000c000cc0080020,
    0x0000060025020080, 0x0800020090828020, 0x000000a080060000,
    0x0000020248085800, 0x0000690848004000, 0x0800210420010200,
    0x2040040080400208, 0x0000080021000020, 0x0600000220d00020,
    0x080000c109002200, 0x4040060200c02000, 0x0280008420500004,
    0x0000421210410000, 0x0000302410080000, 0x0800000404881060,
    0x8900000000820005, 0x0100000061010480, 0x0000084248020000,
    0x0000220841010820, 0x1008080124802000, 0x2000014800822200,
    0x0000000058020800, 0x4800044002280200, 0x1204800010020200,
    0x0214200000040481, 0x1000000004010800, 0x0002000508068100,
    0x4000041014002120,
};
const bitboard_t bishop_magic_mask[N_SQUARES] = {
    0x0040201008040200, 0x0000402010080400, 0x0000004020100a00,
    0x0000000040221400, 0x0000000002442800, 0x0000000204085000,
    0x0000020408102000, 0x0002040810204000, 0x0020100804020000,
    0x0040201008040000, 0x00004020100a0000, 0x0000004022140000,
    0x0000000244280000, 0x0000020408500000, 0x0002040810200000,
    0x0004081020400000, 0x0010080402000200, 0x0020100804000400,
    0x004020100a000a00, 0x0000402214001400, 0x0000024428002800,
    0x0002040850005000, 0x0004081020002000, 0x0008102040004000,
    0x0008040200020400, 0x0010080400040800, 0x0020100a000a1000,
    0x0040221400142200, 0x0002442800284400, 0x0004085000500800,
    0x0008102000201000, 0x0010204000402000, 0x0004020002040800,
    0x0008040004081000, 0x00100a000a102000, 0x0022140014224000,
    0x0044280028440200, 0x0008500050080400, 0x0010200020100800,
    0x0020400040201000, 0x0002000204081000, 0x0004000408102000,
    0x000a000a10204000, 0x0014001422400000, 0x0028002844020000,
    0x0050005008040200, 0x0020002010080400, 0x0040004020100800,
    0x0000020408102000, 0x0000040810204000, 0x00000a1020400000,
    0x0000142240000000, 0x0000284402000000, 0x0000500804020000,
    0x0000201008040200, 0x0000402010080400, 0x0002040810204000,
    0x0004081020400000, 0x000a102040000000, 0x0014224000000000,
    0x0028440200000000, 0x0050080402000000, 0x0020100804020000,
    0x0040201008040200,
};

typedef bitboard_t (*generate_moves_fn)(enum square, bitboard_t);

bitboard_t generate_rook_moves(enum square square, bitboard_t blockers) {
  int rank = square / 8;
  int file = square % 8;
  bitboard_t moves = 0ull;
  for (int i = rank + 1; i < 8; i++) {
    bitboard_t bit = 1ull << (i * 8 + file);
    moves |= bit;
    if (blockers & bit) break;
  }
  for (int i = rank - 1; i >= 0; i--) {
    bitboard_t bit = 1ull << (i * 8 + file);
    moves |= bit;
    if (blockers & bit) break;
  }
  for (int i = file + 1; i < 8; i++) {
    bitboard_t bit = 1ull << (rank * 8 + i);
    moves |= bit;
    if (blockers & bit) break;
  }
  for (int i = file - 1; i >= 0; i--) {
    bitboard_t bit = 1ull << (rank * 8 + i);
    moves |= bit;
    if (blockers & bit) break;
  }
  return moves;
}

bitboard_t generate_bishop_moves(enum square square, bitboard_t blockers) {
  int rank = square / 8;
  int file = square % 8;
  bitboard_t moves = 0ull;
  for (int r = rank + 1, f = file + 1; r < 8 && f < 8; r++, f++) {
    bitboard_t bit = 1ull << (r * 8 + f);
    moves |= bit;
    if (blockers & bit) break;
  }
  for (int r = rank - 1, f = file - 1; r > 0 && f > 0; r--, f--) {
    bitboard_t bit = 1ull << (r * 8 + f);
    moves |= bit;
    if (blockers & bit) break;
  }
  for (int r = rank - 1, f = file + 1; r > 0 && f < 7; r--, f++) {
    bitboard_t bit = 1ull << (r * 8 + f);
    moves |= bit;
    if (blockers & bit) break;
  }
  for (int r = rank + 1, f = file - 1; r < 7 && f > 0; r++, f--) {
    bitboard_t bit = 1ull << (r * 8 + f);
    moves |= bit;
    if (blockers & bit) break;
  }
  return moves;
}

void init_magic_moves(generate_moves_fn generate_moves,
                      const bitboard_t *magic_mask,
                      const bitboard_t *magic_number, bitboard_t *magic_moves) {
  for (enum square square = A1; square <= H8; square++) {
    bitboard_t blocker_mask = magic_mask[square];
    int n_bits = pop_count(blocker_mask);
    for (bitboard_t occupancy = 0; occupancy < (1 << n_bits); occupancy++) {
      bitboard_t blocker_board = unpack_moves(blocker_mask, occupancy);
      bitboard_t hash =
          (blocker_board * magic_number[square]) >> rook_magic_shift[square];
      bitboard_t *entry = &magic_moves[square * 4096 + hash];
      if (!*entry) *entry = generate_moves(square, blocker_board);
    }
  }
}

int check_magics(generate_moves_fn generate_moves, int *shift,
                 bitboard_t *magics, bitboard_t *magic_moves) {
  for (int i = 0; i < 10000000; i++) {
    int square = rand() & 0x3f;
    bitboard_t blocker_mask = generate_blocker_mask(square);
    bitboard_t occ;
    while (!(
        occ = unpack_moves(
            blocker_mask, rand() & ((1ull << pop_count(blocker_mask)) - 1ull))))
      ;
    bitboard_t g_moves = generate_moves(square, occ);
    bitboard_t hash = (occ * magics[square]) >> shift[square];
    bitboard_t m_moves = magic_moves[square * 4096 + hash];
    if (m_moves != g_moves) {
      printf("Occupancy:\n");
      print_board(0, occ, 0);
      printf("Generated moves:\n");
      print_board(0, g_moves, 0);
      printf("Magic moves:\n");
      print_board(0, m_moves, 0);
      return 1;
    }
  }
  return 0;
}

int main(void) {
  bitboard_t *rook_magic_moves =
      malloc(N_SQUARES * 4096 * sizeof(*rook_magic_moves));
  init_magic_moves(generate_rook_moves, rook_magic_mask, rook_magic_number,
                   rook_magic_moves);
  bitboard_t *bishop_magic_moves =
      malloc(N_SQUARES * 4096 * sizeof(*bishop_magic_moves));
  init_magic_moves(generate_bishop_moves, bishop_magic_mask,
                   bishop_magic_number, bishop_magic_moves);
}